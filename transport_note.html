<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Vận Chuyển</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style-transport.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="qrcode.js"></script>
</head>
<body>
    <div class="action-buttons">
        <button class="btn btn-secondary" onclick="goBack()">
            <i class="fas fa-arrow-left"></i> Quay lại
        </button>
        <button class="btn btn-warning" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i> Xuất PDF
        </button>
        <button class="btn btn-success" onclick="window.print()">
            <i class="fas fa-print"></i> In phiếu
        </button>
    </div>
    
    <div class="bill-container">
        <!-- Header -->
        <div class="header">
            <img src="logo1.png" alt="Logo" class="logo">
            <h1>Phiếu Vận Chuyển</h1>
            <div class="bill-info">
                <p>Số phiếu: <span id="billNumber"></span></p>
                <p>Ngày tạo: <span id="billDate"></span></p>
            </div>
        </div>
        
        <!-- Sender and Receiver -->
        <div class="section two-column">
            <div>
                <h2><i class="fas fa-user"></i> Người Gửi (Sender)</h2>
                <div class="info-row">
                    <span class="info-label">Tên:</span>
                    <span class="info-content" id="senderName"></span>
                </div>
              
                
                <div class="info-row">
                    <span class="info-label">Địa chỉ:</span>
                    <span class="info-content" id="senderAddress"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">SĐT:</span>
                    <span class="info-content" id="senderPhone"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-content" id="senderEmail"></span>
                </div>
            </div>
            <div>
                <h2><i class="fas fa-user"></i> Người Nhận (Receiver)</h2>
                <div class="info-row">
                    <span class="info-label">Store/Chi nhánh:</span>
                    <span class="info-content" id="senderStore"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tên:</span>
                    <span class="info-content" id="receiverName"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Địa chỉ:</span>
                    <span class="info-content" id="receiverAddress"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">SĐT:</span>
                    <span class="info-content" id="receiverPhone"></span>
                </div>
            </div>
        </div>
        
        <!-- Cargo Details -->
        <div class="section">
            <h2><i class="fas fa-box"></i> Thông Tin Hàng Hóa (Cargo Details)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Loại Hàng</th>
                        <th>Số Kiện</th>
                        <th>Trọng Lượng (kg)</th>
                        <th>Khối Lượng (m³)</th>
                        <th>Ghi Chú</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Hàng Đông</td>
                        <td id="frozenPkg"></td>
                        <td id="frozenWeight"></td>
                        <td id="frozenVolume"></td>
                        <td id="frozenNote"></td>
                    </tr>
                    <tr>
                        <td>Hàng Mát</td>
                        <td id="coolPkg"></td>
                        <td id="coolWeight"></td>
                        <td id="coolVolume"></td>
                        <td id="coolNote"></td>
                    </tr>
                    <tr>
                        <td>Hàng Khô</td>
                        <td id="dryPkg"></td>
                        <td id="dryWeight"></td>
                        <td id="dryVolume"></td>
                        <td id="dryNote"></td>
                    </tr>
                    <tr style="font-weight: bold ; font-size: 1.1em; background: #f9f9f9;">
                        <td><strong>Tổng</strong></td>
                        <td id="totalPackages"></td>
                        <td id="totalWeight"></td>
                        <td id="totalVolume"></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Transportation Info -->
        <div class="section two-column">
            <div>
                <h2><i class="fas fa-route"></i> Thông Tin Vận Chuyển</h2>
                <div class="info-row">
                    <span class="info-label">Tuyến đường:</span>
                    <span class="info-content" id="route"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Số phiếu:</span>
                    <span class="info-content" id="ticketNumber"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Tài xế:</span>
                    <span class="info-content" id="driver"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">SĐT tài xế:</span>
                    <span class="info-content" id="driverPhone"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Ngày gửi:</span>
                    <span class="info-content" id="sendDate"></span>
                </div>
            </div>
            <div>
                <h2><i class="fas fa-dollar-sign"></i> Chi Phí & Thanh Toán</h2>
                <div class="info-row">
                    <span class="info-label">Số tiền thanh toán:</span>
                    <span class="info-content" id="paymentAmount"></span> VND
                </div>
                <div class="info-row">
                    <span class="info-label">Phương thức thanh toán:</span>
                    <span class="info-content" id="paymentMethod"></span>
                </div>
                
            </div>
        </div>
        
        <!-- Additional Services -->
        <div class="section additional-services">
            <h2><i class="fas fa-plus"></i> Dịch Vụ Phát Sinh</h2>
            <table>
                <thead>
                    <tr>
                        <th>Dịch Vụ</th>
                        <th>Địa chỉ</th>
                        <th>Xác Nhận (Checkbox & Sign)</th>
                    </tr>
                </thead>
                <tbody id="additionalServicesBody">
                    <!-- Nội dung sẽ được thêm bằng JavaScript -->
                </tbody>
            </table>
            
            <p>Ghi chú dịch vụ: <span id="serviceNotes"></span></p>
        </div>
        
        <!-- Notes & Signatures -->
        <div class="section">
            <h2><i class="fas fa-file-alt"></i> Ghi Chú Chung</h2>
            <p id="generalNotes"></p>
        </div>
        
        <div class="signature">
            <div>
                <p>Người Gửi (Sender)</p>
                <div class="line"></div>
                <p>Họ tên & Chữ ký</p>
                <p>Ngày: ___/___/___</p>
            </div>
            <div>
                <p>Người Vận Chuyển (Carrier)</p>
                <div class="line"></div>
                <p>Họ tên & Chữ ký (Dấu công ty)</p>
                <p>Ngày: ___/___/___</p>
            </div>
            <div>
                <p>Người Nhận (Receiver)</p>
                <div class="line"></div>
                <p>Họ tên & Chữ ký</p>
                <p>Ngày: ___/___/___</p>
            </div>
        </div>
    </div>

    <script>
        // Dữ liệu mẫu - sync với index.html
        const customers = JSON.parse(localStorage.getItem('customers')) || [];
        const vehicles = JSON.parse(localStorage.getItem('vehicles')) || [];

        // Load dữ liệu từ localStorage
        let orders = [];
        try {
            orders = JSON.parse(localStorage.getItem('orders')) || [];
            console.log('Loaded orders:', orders);
        } catch (e) {
            console.error('Error loading orders from localStorage:', e);
            orders = [];
        }
        
        // Function để lấy order theo ID từ URL params
        function getOrderIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            console.log('Order ID from URL:', id);
            return id;
        }
        
        // Function để tìm khách hàng theo tên
        function findCustomer(customerName) {
            return customers.find(c => c.name === customerName) || {};
        }
        
        // Function để tìm xe theo số
        function findVehicle(vehicleNumber) {
            return vehicles.find(v => v.number === vehicleNumber) || {};
        }
        
        

        // Function để populate dữ liệu vào phiếu
        function generateBill(orderId) {
            console.log('Generating bill for order ID:', orderId);
            
            if (!orders || orders.length === 0) {
                alert('Không có đơn hàng nào trong hệ thống!');
                return;
            }
            
            const order = orders.find(o => o.id == orderId);
            console.log('Found order:', order);
            
            if (!order) {
                alert('Không tìm thấy đơn hàng với ID: ' + orderId);
                console.log('Available orders:', orders.map(o => ({ id: o.id, customer: o.customer })));
                return;
            }

            // Tìm thông tin khách hàng
            const customerInfo = findCustomer(order.customer);
            const vehicleInfo = findVehicle(order.vehicleNumber);

            // Populate basic info
            document.getElementById('billNumber').textContent = `${order.id}`;
            document.getElementById('billDate').textContent = new Date(order.date).toLocaleDateString('vi-VN');
            
            // Sender info (khách hàng)
            document.getElementById('senderName').textContent = order.customer || 'N/A';
    
            document.getElementById('senderStore').textContent = order.store || 'Chi nhánh chính';
            document.getElementById('senderAddress').textContent = customerInfo.address || 'Chưa cập nhật';
            document.getElementById('senderPhone').textContent = customerInfo.phone || 'Chưa cập nhật';
            document.getElementById('senderEmail').textContent = customerInfo.email || 'Chưa cập nhật';
            
            // Receiver info
            document.getElementById('receiverName').textContent = order.receiverName || order.deliveryContact || 'Khách hàng cuối';
            document.getElementById('receiverAddress').textContent = order.receiverAddress || 'Tuyến ' + (order.route || 'N/A');
            document.getElementById('receiverPhone').textContent = order.receiverPhone || order.deliveryPhone || 'Liên hệ khi giao';
            
            // Cargo details - hiển thị theo loại hàng đã chọn
            const cargoTypeNames = {
                'frozen': 'Hàng Đông Lạnh',
                'cool': 'Hàng Mát',
                'dry': 'Hàng Khô'
            };
            
            // Ẩn tất cả các hàng trước
            document.getElementById('frozenPkg').parentElement.style.display = 'none';
            document.getElementById('coolPkg').parentElement.style.display = 'none';
            document.getElementById('dryPkg').parentElement.style.display = 'none';
            
            // Hiển thị hàng tương ứng với loại hàng
            if (order.cargoType) {
                const cargoData = order[order.cargoType] || {};
                
                if (order.cargoType === 'frozen') {
                    document.getElementById('frozenPkg').parentElement.style.display = '';
                    document.getElementById('frozenPkg').textContent = order.totalPackages || '-';
                    document.getElementById('frozenWeight').textContent = order.totalWeight || '-';
                    document.getElementById('frozenVolume').textContent = order.totalVolume || '-';
                    document.getElementById('frozenNote').textContent = cargoData.note || '-';
                } else if (order.cargoType === 'cool') {
                    document.getElementById('coolPkg').parentElement.style.display = '';
                    document.getElementById('coolPkg').textContent = order.totalPackages || '-';
                    document.getElementById('coolWeight').textContent = order.totalWeight || '-';
                    document.getElementById('coolVolume').textContent = order.totalVolume || '-';
                    document.getElementById('coolNote').textContent = cargoData.note || '-';
                } else if (order.cargoType === 'dry') {
                    document.getElementById('dryPkg').parentElement.style.display = '';
                    document.getElementById('dryPkg').textContent = order.totalPackages || '-';
                    document.getElementById('dryWeight').textContent = order.totalWeight || '-';
                    document.getElementById('dryVolume').textContent = order.totalVolume || '-';
                    document.getElementById('dryNote').textContent = cargoData.note || '-';
                }
            }
            
            document.getElementById('totalPackages').textContent = order.totalPackages || '-';
            document.getElementById('totalWeight').textContent = order.totalWeight || '-';
            document.getElementById('totalVolume').textContent = order.totalVolume || '-';
            
            // Transportation
            document.getElementById('route').textContent = order.route || 'N/A';
            document.getElementById('ticketNumber').textContent = order.ticketNumber || 'Chưa có';
            document.getElementById('driver').textContent = vehicleInfo.driver || order.driver || 'Chưa phân công';
            document.getElementById('driverPhone').textContent = vehicleInfo.phone || order.driverPhone || 'N/A';
            document.getElementById('sendDate').textContent = new Date(order.date).toLocaleDateString('vi-VN');
            
            // Payment information
            document.getElementById('paymentAmount').textContent = order.paymentAmount ? order.paymentAmount.toLocaleString() : '0';
            
            const paymentMethodNames = {
                'bank_transfer': 'Chuyển khoản',
                'cash': 'Tiền mặt',
                'cod': 'Thu hộ (COD)'
            };
            document.getElementById('paymentMethod').textContent = paymentMethodNames[order.paymentMethod] || order.paymentMethod || 'Chưa xác định';
            
            // Không render QR tại phiếu vận chuyển (chỉ hiển thị từ danh sách đơn)
            
            // Additional Services - bao gồm cả dịch vụ lấy và giao tận nơi
            const servicesBody = document.getElementById('additionalServicesBody');
            if (servicesBody) {
                servicesBody.innerHTML = '';
                
                // Thêm dịch vụ lấy tận nơi nếu có
                if (order.pickupAddr && order.pickupAddr !== '') {
                    const pickupRow = document.createElement('tr');
                    pickupRow.innerHTML = `
                        <td>Lấy hàng tận nơi</td>
                        <td>${order.pickupAddr}</td>
                        <td><input type="checkbox"> Xác nhận: _________________________</td>
                    `;
                    servicesBody.appendChild(pickupRow);
                }
                
                // Thêm dịch vụ giao tận nơi nếu có
                if (order.deliveryAddr && order.deliveryAddr !== '') {
                    const deliveryRow = document.createElement('tr');
                    deliveryRow.innerHTML = `
                        <td>Giao hàng tận nơi</td>
                        <td>${order.deliveryAddr}</td>
                        <td><input type="checkbox"> Xác nhận: _________________________</td>
                    `;
                    servicesBody.appendChild(deliveryRow);
                }
                
                // Thêm các dịch vụ khác từ đơn hàng nếu có
                if (order.additionalServices && order.additionalServices.length > 0) {
                    order.additionalServices.forEach(s => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${s.name}</td>
                            <td>${s.desc}</td>
                            <td><input type="checkbox" ${s.confirmed ? 'checked' : ''}> Xác nhận: _________________________</td>
                        `;
                        servicesBody.appendChild(row);
                    });
                }
                
                // Nếu không có dịch vụ nào
                if (servicesBody.children.length === 0) {
                    const noServiceRow = document.createElement('tr');
                    noServiceRow.innerHTML = `
                        <td colspan="3" style="text-align: center;">Không có dịch vụ phát sinh</td>
                    `;
                    servicesBody.appendChild(noServiceRow);
                }
            }
            
            // Notes
            let notes = [];
            if (order.cargoType === 'frozen') notes.push('Hàng đông lạnh - bảo quản -18°C');
            if (order.cargoType === 'cool') notes.push('Hàng mát - bảo quản 0-4°C');
            if (order.cargoType === 'dry') notes.push('Hàng khô - tránh ẩm ướt');
            
            const generalNotesElement = document.getElementById('generalNotes');
            if (generalNotesElement) {
                generalNotesElement.textContent = order.generalNotes || notes.join('. ') || 'Vận chuyển theo quy chuẩn.';
            }
            
            // Service Notes
            document.getElementById('serviceNotes').textContent = order.serviceNotes || '';
            
            console.log('Bill generation completed successfully');
        }
        
        // Function xuất PDF
        function exportToPDF() {
            window.print();
        }
        
        // Function quay lại
        function goBack() {
            window.location.href = 'index.html';
        }
        
        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            
            const orderId = getOrderIdFromURL();
            if (orderId) {
                generateBill(orderId);
            } else {
                alert('Không có ID đơn hàng! Vui lòng truy cập từ danh sách đơn hàng.');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        });
    </script>
</body>
</html>